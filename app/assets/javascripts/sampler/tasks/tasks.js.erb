//= depend_on_asset "tasks/tasks.html"
//= depend_on_asset "tasks/index.html"
//= depend_on_asset "tasks/show.html"
//= depend_on_asset "tasks/edit.html"
"use strict";
angular
  .module('sampler.tasks', ['ui.router', 'sampler.auth'])
  .config(function($stateProvider) {
    $stateProvider
      .state("root.tasks", {
        abstract: true,
        url: "/tasks",
        templateUrl: "<%= asset_path('tasks/tasks.html') %>",
        controller: 'TasksController'
      })
      .state("root.tasks.index", {
        url: "",
        views: {
          '': {
            templateUrl: "<%= asset_path('tasks/index.html') %>",
            controller: 'TasksIndexController'
          },
          'actions': {
            templateUrl: "<%= asset_path('tasks/index_actions.html') %>"
          }
        }
      })
      .state("root.tasks.show", {
        url: '/show/{taskId:.*}',
        templateUrl: "<%= asset_path('tasks/show.html') %>",
        controller: 'TasksShowController'
      })
      .state("root.tasks.edit", {
        url: '/edit/{taskId:.*}',
        templateUrl: "<%= asset_path('tasks/edit.html') %>",
        controller: 'TasksEditController'
      });
  })
  .controller(
    'TasksController',
    function(
      $state,
      $scope,
      Restangular,
      AuthenticationService) {
      AuthenticationService.login("admin", "password");

      $scope.state = $state;
      $scope.base_url = '/api/tasks';
      $scope.data = {
        server: AuthenticationService.getUrl(),
        tasks: []
      };

      $scope.newTask = function() {
        $scope.state.go('root.tasks.edit', { taskId: null } );
      };

      $scope.fetchTasks = function(fn) {
        Restangular.all($scope.base_url)
          .getList()
          .then(fn);
      };

      $scope.reload = function() {
        console.log("start reload");
        $scope.fetchTasks(function(tasks) {
            $scope.data.tasks = tasks;
          });
      };

      $scope.clear = function() {
        $scope.data.tasks = [];
      };
    })
  .controller(
    'TasksIndexController',
    function(
      $scope,
      $filter,
      Restangular,
      ngTableParams) {

      $scope.tableParams = new ngTableParams(
        {
          page: 1,
          count: 5,
          sorting: {
            name: 'asc'
          }
        },
        {
          total: function () {
            return $scope.tasks.size();
          },
          getData: function($defer, params) {
            console.log("reload table");
            $scope.fetchTasks(function(tasks) {
              $scope.data.tasks = tasks;
              if (params.filter()) {
                tasks = $filter('filter')(tasks, params.filter());
              }
              if (params.sorting()) {
                tasks = $filter('orderBy')(tasks, params.orderBy());
              }
              var pg = params.page();
              var count = params.count();
              $defer.resolve(tasks.slice((pg - 1) * count, pg * count));
            });
          }
        });

      $scope.clear = function() {
        $scope.data.tasks = [];
      };
    })
  .controller(
    'TasksShowController',
    function(
      $scope,
      $stateParams,
      Restangular) {
      console.log("show");

      $scope.task = {};

      if ($stateParams.taskId) {
        Restangular.one($scope.base_url, $stateParams.taskId).get().then(
          function(task) {
            $scope.task = task;
          });
      }

      $scope.deleteTask = function() {
        if (window.confirm("Delete " + $scope.task.name)) {
          $scope.task.remove().then(function() {
            console.log("removed");
            $scope.state.go('^.index');
          });
          $scope.state.go('^.index');
        }
      };
    })
  .controller(
    'TasksEditController',
    function(
      $scope,
      $stateParams,
      Restangular) {
      console.log("show");

      $scope.task = {};

      if ($stateParams.taskId) {
        Restangular.one($scope.base_url, $stateParams.taskId).get().then(
          function(task) {
            $scope.task = task;
          });
      }

      $scope.save = function() {
        var task = $scope.task;
        var fn = function(task) {
          $scope.state.go('^.show', { taskId: task.id });
        };
        if (task.id) {
          task.save().then(fn);
        } else {
          console.log("new task");
          console.log(task);
          Restangular.all($scope.base_url).post(task).then(fn);
        }
      };

      $scope.cancel = function() {
        var task = $scope.task;
        if (task.id) {
          $scope.state.go('^.show', { taskId: task.id });
        } else {
          $scope.state.go('^.index');
        }
      };
    });
