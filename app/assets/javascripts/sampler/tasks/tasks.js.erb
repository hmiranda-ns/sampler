//= depend_on_asset "tasks/tasks.html"
//= depend_on_asset "tasks/index.html"
//= depend_on_asset "tasks/show.html"
//= depend_on_asset "tasks/edit.html"
"use strict";
angular
  .module('sampler.tasks', ['ui.router', 'sampler.auth'])
  .config(function($stateProvider) {
    $stateProvider
      .state("tasks", {
        abstract: true,
        url: "/tasks",
        templateUrl: "<%= asset_path('tasks/tasks.html') %>",
        controller: 'TasksController'
      })
      .state("tasks.index", {
        url: "",
        views: {
          '': {
            templateUrl: "<%= asset_path('tasks/index.html') %>",
            controller: 'TasksIndexController'
          },
          'actions': {
            templateUrl: "<%= asset_path('tasks/index_actions.html') %>"
          }
        }
      })
      .state("tasks.show", {
        url: '/show/{taskId:.*}',
        templateUrl: "<%= asset_path('tasks/show.html') %>",
        controller: 'TasksShowController'
      })
      .state("tasks.edit", {
        url: '/edit/{taskId:.*}',
        templateUrl: "<%= asset_path('tasks/edit.html') %>",
        controller: 'TasksEditController'
      });
  })
  .controller(
    'TasksController',
    function(
      $state,
      $scope,
      Restangular,
      AuthenticationService) {
      AuthenticationService.login("admin", "password");

      $scope.state = $state;
      $scope.base_url = '/api/tasks';
      $scope.data = {
        server: AuthenticationService.getUrl(),
        tasks: []
      };

      $scope.newTask = function() {
        $scope.state.go('tasks.edit', { taskId: null } );
      };

      $scope.reload = function() {
        console.log("start reload");
        Restangular.all($scope.base_url)
          .getList()
          .then(function(tasks) {
            $scope.data.tasks = tasks;
          });
      };

      $scope.clear = function() {
        $scope.data.tasks = [];
      };

    })
  .controller(
    'TasksIndexController',
    function(
      $scope,
      Restangular) {

      $scope.reload();
    })
  .controller(
    'TasksShowController',
    function(
      $scope,
      $stateParams,
      Restangular) {
      console.log("show");

      $scope.task = {};

      if ($stateParams.taskId) {
        Restangular.one($scope.base_url, $stateParams.taskId).get().then(
          function(task) {
            $scope.task = task;
          });
      }

      $scope.deleteTask = function() {
        $scope.task.remove().then(function() {
          console.log("removed");
          $scope.state.go('tasks.index');
        });
        $scope.state.go('tasks.index');
      };
    })
  .controller(
    'TasksEditController',
    function(
      $scope,
      $stateParams,
      Restangular) {
      console.log("show");

      $scope.task = {};

      if ($stateParams.taskId) {
        Restangular.one($scope.base_url, $stateParams.taskId).get().then(
          function(task) {
            $scope.task = task;
          });
      }

      $scope.save = function() {
        var task = $scope.task;
        var fn = function(task) {
          $scope.state.go('tasks.show', { taskId: task.id });
        };
        if (task.id) {
          task.save().then(fn);
        } else {
          console.log("new task");
          console.log(task);
          Restangular.all($scope.base_url).post(task).then(fn);
        }
      };

      $scope.cancel = function() {
        var task = $scope.task;
        if (task.id) {
          $scope.state.go('tasks.show', { taskId: task.id });
        } else {
          $scope.state.go('tasks.index');
        }
      };
    });
