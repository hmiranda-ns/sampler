!function(e,t,n){var r=t.module("ng-auth.strategies.oauth2",["ng-auth.store","ng-auth","ng-auth.constants"]),o=function(e){var n=[];return t.forEach(e,function(e,t){n.push(encodeURIComponent(t)+"="+encodeURIComponent(e))}),n.join("&")},i=e.location.hash,a=function(e,r){this.$get=["$location","$q","$window","$injector","authStore","util","REQUIRED",function(a,u,s,c,f,h,l){var p=t.extend;forEach=t.forEach;var d={storeKey:function(e){return"ng-auth-oauth2-"+e},stateStoreKey:function(e){return"ng-auth-oauth2-state-"+e},display:"popup",redirectUri:function(){return a.absUrl()},requestConfig:function(e){return{headers:{Authorization:"Bearer "+e}}},authorizeUri:l,clientId:l,responseType:"token",scopes:[],scope:function(e){return e.join(" ")},extraParams:{},validateState:!0,state:function(){var e=function(){return(Math.random()+1).toString(36).substring(7)};return e()+e()},beforeAuth:function(){var e=u.defer();return e.resolve(),e.promise},afterAuth:[function(){return function(){var e=u.defer();return e.resolve(arguments),e.promise}}],popup:{width:650,height:300,resizable:!0,scrollbars:!0,status:!0}};e.popup=p(d.popup,e.popup||{}),e=p(d,e||{});var v=h.callIfFunction(e.storeKey,r),g=h.callIfFunction(e.stateStoreKey,r),m=f.get(v)||null,w=m?m.access_token:null;m&&c.invoke(e.afterAuth)(m).then(n,function(){m=null,w=null,f.remove(v)});var k={},b=function(t){if(e.validateState){if(!t.state)throw new Error("OAuth2 error: access_token provided but no state.");var n=f.get(g);if(n!=t.state)throw new Error("Oauth2 error: state mismatch")}f.set(v,t),m=t,w=t.access_token};if("popup"==e.display)t.element(s).bind("message",function(e){var t=e.source.name?k[e.source.name]:null;t&&e.source==t.window&&e.origin==s.location.origin&&(e.data.access_token?t.deferred.resolve(e.data):t.reject(e.data))});else if(!w&&i.indexOf("access_token=")>-1){var y={};forEach(i.replace(/#\/|#/,"").split("&"),function(e){var t=e.split("=");y[t[0]]=t[1]}),b(y),s.location.href=a.absUrl().split("#")[0]}var A=[];if(forEach(e,function(e,t){e==l&&A.push(t)}),A.length>0)throw new Error("OAuth2 configuration error, missing the following properties from config: "+A.join(", "));return{getAccessToken:function(){var t=u.defer();if(w)return c.invoke(e.afterAuth)(m).then(function(){t.resolve(w)}),t.promise;var n=function(){var t=h.callIfFunction(e.state);f.set(g,t);var n={response_type:e.responseType,client_id:e.clientId,redirect_uri:h.callIfFunction(e.redirectUri),scope:e.scope(e.scopes),state:t};return n=p(n,e.extraParams),e.authorizeUri+"?"+o(n)},r=function(){var t=u.defer(),r=function(e){var t=[];return forEach(e,function(e,n){(e||0===e)&&(e=e===!0?"yes":e,t.push(n+"="+e))}),t.join(",")},o=(Math.random()+1).toString(36).substring(7),i=s.open(n(),o,r(e.popup));return k[o]={window:i,deferred:t},i.onbeforeunload=function(){delete k[i.name]},t.promise},i=function(){c.invoke(e.beforeAuth).then(function(){s.location.href=n()})},a=this;return e.beforeAuth.call(a).then(function(){return"popup"!=e.display?(i(),t.promise):void r().then(function(e){return b(e),e}).then(c.invoke(e.afterAuth)).then(function(e){t.resolve(e)},function(e){t.reject(e)})}),t.promise},requestConfig:function(){return e.requestConfig(w)},forgetAccessToken:function(){w=null,f.remove(v)},config:e,accessToken:w,accessTokenData:m}}]};r.constant("$$oauth2Provider",a),r.config(["authProvider",function(e){e.registerStrategy("oauth2",a)}])}(window,window.angular);